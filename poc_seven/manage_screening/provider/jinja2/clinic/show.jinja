{% extends "layout.html" %}
{% from 'nhsuk/components/tables/macro.jinja' import table %}

{% block content %}
  <h1>Clinic appointments</h1>

  {{ table({
    "responsive": True,
    "panel_title": "Appointments",
    "head": [
      {"text": headers[0]},
      {"text": headers[1]},
      {"text": headers[2]},
      {"text": headers[3]},
      {"text": headers[4]}
    ],
    "rows": rows
  }) }}
{% endblock %}

{% block extra_scripts %}
<script>
  // Use Server-Sent Events for real-time appointment status updates
  const clinicId = "{{ clinic.id }}";
  let statusEventSource = null;

  function connectStatusSSE() {
    // Close existing connection if any
    if (statusEventSource) {
      statusEventSource.close();
    }

    // Establish SSE connection for clinic status updates
    const statusSSEUrl = `/api/clinic/${clinicId}/statuses/stream`;
    statusEventSource = new EventSource(statusSSEUrl);

    statusEventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        if (data.type === 'connected') {
          console.log('Clinic status SSE connection established');
        } else if (data.type === 'status_change') {
          // Update the specific appointment status
          const statusElement = document.querySelector(`[data-appointment-id="${data.appointment_id}"]`);
          if (statusElement && statusElement.innerHTML !== data.html) {
            statusElement.innerHTML = data.html;
            // Add a brief highlight animation when status changes
            statusElement.classList.add('status-updated');
            setTimeout(() => statusElement.classList.remove('status-updated'), 1000);
          }
        } else if (data.type === 'error') {
          console.error('Clinic status SSE error:', data.message);
        }
      } catch (error) {
        console.error('Error parsing clinic status SSE message:', error);
      }
    };

    statusEventSource.onerror = function(error) {
      console.error('Clinic status SSE connection error:', error);
      statusEventSource.close();

      // Attempt to reconnect after 5 seconds
      setTimeout(connectStatusSSE, 5000);
    };
  }

  // Start SSE connection when page loads
  connectStatusSSE();

  // Clean up connection when page unloads
  window.addEventListener('beforeunload', function() {
    if (statusEventSource) {
      statusEventSource.close();
    }
  });
</script>

<style>
  .status-updated {
    animation: highlight 1s ease-in-out;
  }

  @keyframes highlight {
    0%, 100% { background-color: transparent; }
    50% { background-color: #ffe16f; }
  }
</style>
{% endblock %}
