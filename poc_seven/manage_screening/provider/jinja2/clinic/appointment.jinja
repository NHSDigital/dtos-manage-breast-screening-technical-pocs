{% extends "layout.html" %}
{% from 'nhsuk/components/back-link/macro.jinja' import backLink %}

{% block beforeContent %}
  {{ backLink({
    "href": "/clinic/" + clinic.id|string,
    "text": "Back to clinic list"
  }) }}
{% endblock %}

{% block content %}
  <h1>{{ participant.first_name }} {{ participant.last_name }}</h1>

  <div class="nhsuk-inset-text">
    <span class="nhsuk-u-visually-hidden">Status: </span>
    <span id="appointment-status" data-appointment-id="{{ appointment.id }}" data-state="{{ appointment.state }}">
      {{ format_status(appointment.state)|safe }}
    </span>
    {% if not has_images %}
      {% if appointment.state == 'pending' %}
        <span id="no-images-message" class="status-message"> - No images to display</span>
      {% else %}
        <span id="no-images-message" class="status-message"> - Awaiting images...</span>
      {% endif %}
    {% endif %}
  </div>

  <div id="images-container">
    {% if organized_images %}
      <div class="nhsuk-grid-row">
        {% for laterality_group in organized_images %}
          <div class="nhsuk-grid-column-one-half" data-laterality="{{ laterality_group.laterality }}">
            <div class="nhsuk-card nhsuk-card--feature">
              <div class="nhsuk-card__content nhsuk-card__content--feature">
                <h2 class="nhsuk-card__heading nhsuk-card__heading--feature">
                  {{ laterality_group.laterality_display }}
                </h2>

                {% for series_group in laterality_group.series_groups %}
                  <div class="series-group {% if not loop.last %}nhsuk-u-margin-bottom-3{% endif %}" data-series-id="{{ series_group.series_id }}">
                    <h3 class="nhsuk-u-margin-bottom-2">
                      {{ series_group.count }}× {{ series_group.view_position }}
                    </h3>
                    <div class="image-thumbnails">
                      {% for image in series_group.images %}
                        <div class="app-mammogram-image--placeholder nhsuk-u-margin-right-3" style="float:left" data-image-id="{{ image.id }}" data-instance-number="{{ image.instance_number }}">
                          <img class="nhsuk-image__img" src="{{ image.thumbnail.url }}" alt="">
                        </div>
                      {% endfor %}
                      <div style="clear:both"></div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_styles %}
<style>
  .status-message {
    color: #4c6272;
    font-weight: normal;
  }

  .app-mammogram-image--placeholder {
    width: 150px;
    height: 150px;
    display: inline-block;
  }

  .app-mammogram-image--placeholder img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .image-added {
    animation: slideInFade 0.5s ease-in-out;
  }

  @keyframes slideInFade {
    0% {
      opacity: 0;
      transform: translateY(-20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .status-updated {
    animation: highlight 1s ease-in-out;
  }

  @keyframes highlight {
    0%, 100% { background-color: transparent; }
    50% { background-color: #ffe16f; }
  }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
  // Use Server-Sent Events for real-time image and status updates
  const clinicId = "{{ clinic.id }}";
  const appointmentId = "{{ appointment.id }}";
  let imageEventSource = null;
  let statusEventSource = null;

  // Store series data by laterality and series
  const seriesData = {};

  function createLateralityCard(laterality, lateralityDisplay) {
    return `
      <div class="nhsuk-grid-column-one-half" data-laterality="${laterality}">
        <div class="nhsuk-card nhsuk-card--feature">
          <div class="nhsuk-card__content nhsuk-card__content--feature">
            <h2 class="nhsuk-card__heading nhsuk-card__heading--feature">
              ${lateralityDisplay}
            </h2>
          </div>
        </div>
      </div>
    `;
  }

  function createSeriesGroup(viewPosition, count, seriesId) {
    return `
      <div class="series-group" data-series-id="${seriesId}">
        <h3 class="nhsuk-u-margin-bottom-2">
          ${count}× ${viewPosition}
        </h3>
        <div class="image-thumbnails">
        </div>
      </div>
    `;
  }

  function createImageThumbnail(image) {
    return `
      <div class="app-mammogram-image--placeholder nhsuk-u-margin-right-3 image-added" style="float:left" data-image-id="${image.id}" data-instance-number="${image.instance_number}">
        <img class="nhsuk-image__img" src="${image.thumbnail_url}" alt="">
      </div>
    `;
  }

  function updateStatusMessage(state) {
    const statusElement = document.getElementById('appointment-status');
    let noImagesMessage = document.getElementById('no-images-message');

    // Check if there are any images displayed
    const hasImages = document.querySelector('[data-laterality]') !== null;

    if (hasImages) {
      // Remove message if images are present
      if (noImagesMessage) {
        noImagesMessage.remove();
      }
    } else {
      // Update or create message based on state
      const messageText = state === 'pending' ? ' - No images to display' : ' - Awaiting images...';

      if (noImagesMessage) {
        noImagesMessage.textContent = messageText;
      } else {
        // Create message if it doesn't exist
        const newMessage = document.createElement('span');
        newMessage.id = 'no-images-message';
        newMessage.className = 'status-message';
        newMessage.textContent = messageText;
        statusElement.parentElement.appendChild(newMessage);
      }
    }
  }

  function addNewImage(study, image) {
    const container = document.getElementById('images-container');

    // Check if image already exists
    const existingImage = document.querySelector(`[data-image-id="${image.id}"]`);
    if (existingImage) {
      return; // Image already displayed
    }

    // Determine laterality
    const laterality = image.laterality.toUpperCase();
    const lateralityDisplay = laterality === 'R' ? 'Right breast' : laterality === 'L' ? 'Left breast' : 'Unknown';

    // Check if we have a grid row
    let gridRow = container.querySelector('.nhsuk-grid-row');
    if (!gridRow) {
      gridRow = document.createElement('div');
      gridRow.className = 'nhsuk-grid-row';
      container.appendChild(gridRow);
    }

    // Check if laterality card exists
    let lateralityCard = gridRow.querySelector(`[data-laterality="${laterality}"]`);
    if (!lateralityCard) {
      // Create laterality card in correct position (R before L)
      const lateralityOrder = ['R', 'L'];
      const lateralityIndex = lateralityOrder.indexOf(laterality);

      if (lateralityIndex === 0 || gridRow.children.length === 0) {
        // Insert at beginning
        gridRow.insertAdjacentHTML('afterbegin', createLateralityCard(laterality, lateralityDisplay));
      } else {
        // Insert after first card
        gridRow.insertAdjacentHTML('beforeend', createLateralityCard(laterality, lateralityDisplay));
      }

      lateralityCard = gridRow.querySelector(`[data-laterality="${laterality}"]`);
    }

    // Get the card content
    const cardContent = lateralityCard.querySelector('.nhsuk-card__content--feature');

    // Check if series group exists
    let seriesGroup = cardContent.querySelector(`[data-series-id="${image.series_id}"]`);
    if (!seriesGroup) {
      // Track series in our data structure
      const seriesKey = `${laterality}-${image.series_id}`;
      if (!seriesData[seriesKey]) {
        seriesData[seriesKey] = {
          count: 0,
          viewPosition: image.view_position
        };
      }
      seriesData[seriesKey].count++;

      // Create series group
      cardContent.insertAdjacentHTML('beforeend', createSeriesGroup(
        image.view_position,
        seriesData[seriesKey].count,
        image.series_id
      ));
      seriesGroup = cardContent.querySelector(`[data-series-id="${image.series_id}"]`);
    } else {
      // Update count in existing series group
      const seriesKey = `${laterality}-${image.series_id}`;
      if (!seriesData[seriesKey]) {
        seriesData[seriesKey] = {
          count: seriesGroup.querySelectorAll('[data-image-id]').length,
          viewPosition: image.view_position
        };
      }
      seriesData[seriesKey].count++;

      // Update heading
      const heading = seriesGroup.querySelector('h3');
      heading.textContent = `${seriesData[seriesKey].count}× ${image.view_position}`;
    }

    // Add image to thumbnails container
    const thumbnailsContainer = seriesGroup.querySelector('.image-thumbnails');

    // Find correct position based on instance number
    const existingThumbnails = Array.from(thumbnailsContainer.querySelectorAll('[data-image-id]'));
    const newInstanceNum = parseInt(image.instance_number || '999', 10);

    let insertBefore = null;
    for (const thumb of existingThumbnails) {
      const thumbInstanceNum = parseInt(thumb.getAttribute('data-instance-number') || '999', 10);
      if (newInstanceNum < thumbInstanceNum) {
        insertBefore = thumb;
        break;
      }
    }

    if (insertBefore) {
      insertBefore.insertAdjacentHTML('beforebegin', createImageThumbnail(image));
    } else {
      // Insert before the clear div if it exists, or at end
      const clearDiv = thumbnailsContainer.querySelector('div[style*="clear"]');
      if (clearDiv) {
        clearDiv.insertAdjacentHTML('beforebegin', createImageThumbnail(image));
      } else {
        thumbnailsContainer.insertAdjacentHTML('beforeend', createImageThumbnail(image));
        thumbnailsContainer.insertAdjacentHTML('beforeend', '<div style="clear:both"></div>');
      }
    }

    // Update status message
    const statusElement = document.getElementById('appointment-status');
    const currentState = statusElement.getAttribute('data-state');
    updateStatusMessage(currentState);
  }

  function connectImageSSE() {
    // Close existing connection if any
    if (imageEventSource) {
      imageEventSource.close();
    }

    // Establish SSE connection for images
    const imageSSEUrl = `/api/clinic/${clinicId}/appointment/${appointmentId}/images/stream`;
    imageEventSource = new EventSource(imageSSEUrl);

    imageEventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        if (data.type === 'connected') {
          console.log('Image SSE connection established');
        } else if (data.type === 'new_image') {
          console.log('New image received:', data.image);
          addNewImage(data.study, data.image);
        } else if (data.type === 'error') {
          console.error('Image SSE error:', data.message);
        }
      } catch (error) {
        console.error('Error parsing image SSE message:', error);
      }
    };

    imageEventSource.onerror = function(error) {
      console.error('Image SSE connection error:', error);
      imageEventSource.close();

      // Attempt to reconnect after 5 seconds
      setTimeout(connectImageSSE, 5000);
    };
  }

  function connectStatusSSE() {
    // Close existing connection if any
    if (statusEventSource) {
      statusEventSource.close();
    }

    // Establish SSE connection for status updates
    const statusSSEUrl = `/api/clinic/${clinicId}/appointment/${appointmentId}/status/stream`;
    statusEventSource = new EventSource(statusSSEUrl);

    statusEventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        if (data.type === 'connected') {
          console.log('Status SSE connection established');
        } else if (data.type === 'status_change') {
          console.log('Status changed:', data.state);
          const statusElement = document.getElementById('appointment-status');
          if (statusElement) {
            statusElement.innerHTML = data.html;
            statusElement.setAttribute('data-state', data.state);
            // Add a brief highlight animation when status changes
            statusElement.classList.add('status-updated');
            setTimeout(() => statusElement.classList.remove('status-updated'), 1000);

            // Update the status message based on new state
            updateStatusMessage(data.state);
          }
        } else if (data.type === 'error') {
          console.error('Status SSE error:', data.message);
        }
      } catch (error) {
        console.error('Error parsing status SSE message:', error);
      }
    };

    statusEventSource.onerror = function(error) {
      console.error('Status SSE connection error:', error);
      statusEventSource.close();

      // Attempt to reconnect after 5 seconds
      setTimeout(connectStatusSSE, 5000);
    };
  }

  // Start SSE connections when page loads
  connectImageSSE();
  connectStatusSSE();

  // Clean up connections when page unloads
  window.addEventListener('beforeunload', function() {
    if (imageEventSource) {
      imageEventSource.close();
    }
    if (statusEventSource) {
      statusEventSource.close();
    }
  });
</script>
{% endblock %}
