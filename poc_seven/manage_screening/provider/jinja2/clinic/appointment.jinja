{% extends "layout.html" %}

{% block content %}
  <h1>{{ participant.first_name }} {{ participant.last_name }}</h1>

  <div class="nhsuk-inset-text">
    <span class="nhsuk-u-visually-hidden">Status: </span>
    <span id="appointment-status" data-appointment-id="{{ appointment.id }}">
      {{ format_status(appointment.state)|safe }}
    </span>
  </div>

  <div id="images-container">
    {% if studies_with_images %}
      {% for study_data in studies_with_images %}
        <div class="study-group" data-study-id="{{ study_data.study.id }}">
          <h2 class="study-heading">Study: {{ study_data.study.accession_number }} - {{ study_data.study.study_date[:4] }}/{{ study_data.study.study_date[4:6] }}/{{ study_data.study.study_date[6:] }} {{ study_data.study.study_time[:2] }}:{{ study_data.study.study_time[2:4] }}</h2>
          <div class="image-list">
            {% for image in study_data.images %}
              <div class="image-panel" data-image-id="{{ image.id }}">
                <div class="nhsuk-grid-row">
                  <div class="nhsuk-grid-column-one-third">
                    <div class="image-thumbnail">
                      <img src="{{ image.thumbnail.url }}" alt="Image {{ image.instance_number }}">
                    </div>
                  </div>
                  <div class="nhsuk-grid-column-two-thirds">
                    <div class="image-details">
                      <div class="image-detail-row">
                        <strong>Side:</strong> {{ image.laterality|upper if image.laterality else 'N/A' }}
                      </div>
                      <div class="image-detail-row">
                        <strong>View:</strong> {{ image.view_position if image.view_position else 'N/A' }}
                      </div>
                      <div class="image-detail-row">
                        <strong>Received:</strong> {{ image.received_at.strftime('%d/%m/%Y %H:%M') }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p id="no-images-message">No images available for this appointment.</p>
    {% endif %}
  </div>
{% endblock %}

{% block extra_styles %}
<style>
  .study-group {
    margin-bottom: 3rem;
  }

  .study-heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #005eb8;
    color: #005eb8;
  }

  .image-list {
    margin-top: 1rem;
  }

  .image-panel {
    background-color: #f5f5f5;
    padding: 1.5rem;
    border-radius: 4px;
    margin-bottom: 1rem;
  }

  .image-thumbnail img {
    max-width: 100%;
    width: 100%;
    height: auto;
    border: 1px solid #ccc;
    display: block;
  }

  .image-details {
    padding-top: 0.5rem;
  }

  .image-detail-row {
    line-height: 1.6;
    font-size: 1.125rem;
    margin-bottom: 0.75rem;
  }

  .image-detail-row strong {
    display: inline-block;
    min-width: 110px;
  }

  .image-added {
    animation: slideInFade 0.5s ease-in-out;
  }

  @keyframes slideInFade {
    0% {
      opacity: 0;
      transform: translateY(-20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .status-updated {
    animation: highlight 1s ease-in-out;
  }

  @keyframes highlight {
    0%, 100% { background-color: transparent; }
    50% { background-color: #ffe16f; }
  }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
  // Use Server-Sent Events for real-time image and status updates
  const clinicId = "{{ clinic.id }}";
  const appointmentId = "{{ appointment.id }}";
  let imageEventSource = null;
  let statusEventSource = null;

  function formatStudyDateTime(studyDate, studyTime) {
    // Convert YYYYMMDD to YYYY/MM/DD
    const date = `${studyDate.substring(0, 4)}/${studyDate.substring(4, 6)}/${studyDate.substring(6, 8)}`;
    // Convert HHMMSS to HH:MM
    const time = `${studyTime.substring(0, 2)}:${studyTime.substring(2, 4)}`;
    return `${date} ${time}`;
  }

  function createStudyGroup(study) {
    const dateTime = formatStudyDateTime(study.study_date, study.study_time);
    return `
      <div class="study-group" data-study-id="${study.id}">
        <h2 class="study-heading">Study: ${study.accession_number} - ${dateTime}</h2>
        <div class="image-list"></div>
      </div>
    `;
  }

  function createImagePanel(image) {
    return `
      <div class="image-panel image-added" data-image-id="${image.id}">
        <div class="nhsuk-grid-row">
          <div class="nhsuk-grid-column-one-third">
            <div class="image-thumbnail">
              <img src="${image.thumbnail_url}" alt="Image ${image.instance_number}">
            </div>
          </div>
          <div class="nhsuk-grid-column-two-thirds">
            <div class="image-details">
              <div class="image-detail-row">
                <strong>Side:</strong> ${image.laterality}
              </div>
              <div class="image-detail-row">
                <strong>View:</strong> ${image.view_position}
              </div>
              <div class="image-detail-row">
                <strong>Received:</strong> ${image.received_at}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function addNewImage(study, image) {
    const container = document.getElementById('images-container');
    const noImagesMessage = document.getElementById('no-images-message');

    // Remove "no images" message if it exists
    if (noImagesMessage) {
      noImagesMessage.remove();
    }

    // Check if image already exists
    const existingPanel = document.querySelector(`[data-image-id="${image.id}"]`);
    if (existingPanel) {
      return; // Image already displayed
    }

    // Check if study group exists
    let studyGroup = document.querySelector(`[data-study-id="${study.id}"]`);

    if (!studyGroup) {
      // Create new study group
      container.insertAdjacentHTML('beforeend', createStudyGroup(study));
      studyGroup = document.querySelector(`[data-study-id="${study.id}"]`);
    }

    // Add image to the study's image list
    const imageList = studyGroup.querySelector('.image-list');
    imageList.insertAdjacentHTML('beforeend', createImagePanel(image));
  }

  function connectImageSSE() {
    // Close existing connection if any
    if (imageEventSource) {
      imageEventSource.close();
    }

    // Establish SSE connection for images
    const imageSSEUrl = `/api/clinic/${clinicId}/appointment/${appointmentId}/images/stream`;
    imageEventSource = new EventSource(imageSSEUrl);

    imageEventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        if (data.type === 'connected') {
          console.log('Image SSE connection established');
        } else if (data.type === 'new_image') {
          console.log('New image received:', data.image);
          addNewImage(data.study, data.image);
        } else if (data.type === 'error') {
          console.error('Image SSE error:', data.message);
        }
      } catch (error) {
        console.error('Error parsing image SSE message:', error);
      }
    };

    imageEventSource.onerror = function(error) {
      console.error('Image SSE connection error:', error);
      imageEventSource.close();

      // Attempt to reconnect after 5 seconds
      setTimeout(connectImageSSE, 5000);
    };
  }

  function connectStatusSSE() {
    // Close existing connection if any
    if (statusEventSource) {
      statusEventSource.close();
    }

    // Establish SSE connection for status updates
    const statusSSEUrl = `/api/clinic/${clinicId}/appointment/${appointmentId}/status/stream`;
    statusEventSource = new EventSource(statusSSEUrl);

    statusEventSource.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);

        if (data.type === 'connected') {
          console.log('Status SSE connection established');
        } else if (data.type === 'status_change') {
          console.log('Status changed:', data.state);
          const statusElement = document.getElementById('appointment-status');
          if (statusElement) {
            statusElement.innerHTML = data.html;
            // Add a brief highlight animation when status changes
            statusElement.classList.add('status-updated');
            setTimeout(() => statusElement.classList.remove('status-updated'), 1000);
          }
        } else if (data.type === 'error') {
          console.error('Status SSE error:', data.message);
        }
      } catch (error) {
        console.error('Error parsing status SSE message:', error);
      }
    };

    statusEventSource.onerror = function(error) {
      console.error('Status SSE connection error:', error);
      statusEventSource.close();

      // Attempt to reconnect after 5 seconds
      setTimeout(connectStatusSSE, 5000);
    };
  }

  // Start SSE connections when page loads
  connectImageSSE();
  connectStatusSSE();

  // Clean up connections when page unloads
  window.addEventListener('beforeunload', function() {
    if (imageEventSource) {
      imageEventSource.close();
    }
    if (statusEventSource) {
      statusEventSource.close();
    }
  });
</script>
{% endblock %}
