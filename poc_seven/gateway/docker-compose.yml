services:
  # Standalone DICOM Modality Worklist Server (no Orthanc dependency)
  worklist-server:
    build:
      context: .
      dockerfile: Dockerfile.worklist
    container_name: worklist-server
    ports:
      # Modality Worklist / MPPS DICOM port
      - "4243:4243"
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Persist worklist database
      - worklist-db:/var/lib/worklist
      # Persist logs
      - worklist-logs:/var/log/worklist
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - mwl-network

  # Standalone DICOM PACS Server (for image storage)
  pacs-server:
    build:
      context: .
      dockerfile: Dockerfile.pacs
    container_name: pacs-server
    ports:
      # PACS DICOM port (C-STORE, C-ECHO)
      - "4244:4244"
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Persist PACS database and metadata
      - pacs-db:/var/lib/pacs
      # Persist DICOM storage
      - pacs-storage:/var/lib/pacs/storage
      # Mount thumbnails to local directory for easy access
      - ./pacs_data/thumbnails:/var/lib/pacs/thumbnails
      # Persist logs
      - pacs-logs:/var/log/pacs
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - mwl-network

  relay-listener:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: relay-listener
    entrypoint: python3
    command: /scripts/relay_listener.py
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Shared worklist database
      - worklist-db:/var/lib/worklist
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - WORKLIST_DB_PATH=/var/lib/worklist/worklist.db
    restart: unless-stopped
    networks:
      - mwl-network
    depends_on:
      - worklist-server

  # Image Listener Service (polls PACS for new images, generates thumbnails, sends messages)
  image-listener:
    build:
      context: .
      dockerfile: Dockerfile.pacs
    container_name: image-listener
    entrypoint: python3
    command: /scripts/image_listener.py
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Shared PACS storage (read-only for DICOM files)
      - pacs-storage:/var/lib/pacs/storage:ro
      # Shared PACS database
      - pacs-db:/var/lib/pacs
      # Shared worklist database (read-only for action_id lookup)
      - worklist-db:/var/lib/worklist:ro
      # Mount thumbnails to local directory
      - ./pacs_data/thumbnails:/var/lib/pacs/thumbnails
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/scripts
      - PACS_DB_PATH=/var/lib/pacs/pacs.db
      - PACS_STORAGE_ROOT=/var/lib/pacs/storage
      - THUMBNAIL_ROOT=/var/lib/pacs/thumbnails
      - WORKLIST_DB_PATH=/var/lib/worklist/worklist.db
      - IMAGE_POLL_INTERVAL=5
      - IMAGE_BATCH_SIZE=10
      - THUMBNAIL_QUALITY=25
      - THUMBNAIL_HEIGHT=188
      - LOG_LEVEL=INFO
    restart: unless-stopped
    networks:
      - mwl-network
    depends_on:
      - pacs-server
      - worklist-server

volumes:
  worklist-db:
    driver: local
  worklist-logs:
    driver: local
  pacs-db:
    driver: local
  pacs-storage:
    driver: local
  pacs-logs:
    driver: local

networks:
  mwl-network:
    driver: bridge
