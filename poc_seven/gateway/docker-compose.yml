services:
  # Standalone DICOM Modality Worklist Server (no Orthanc dependency)
  worklist-server:
    build:
      context: .
      dockerfile: Dockerfile.worklist
    container_name: worklist-server
    ports:
      # Modality Worklist / MPPS DICOM port
      - "4243:4243"
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Persist worklist database
      - worklist-db:/var/lib/worklist
      # Persist logs
      - worklist-logs:/var/log/worklist
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - mwl-network

  # Standalone DICOM PACS Server (for image storage)
  pacs-server:
    build:
      context: .
      dockerfile: Dockerfile.pacs
    container_name: pacs-server
    ports:
      # PACS DICOM port (C-STORE, C-ECHO)
      - "4244:4244"
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Persist DICOM storage
      - pacs-storage:/var/lib/pacs/storage
      # Persist logs
      - pacs-logs:/var/log/pacs
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - mwl-network

  # Orthanc DICOM server (kept for potential image storage/routing)
  orthanc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orthanc-gateway
    ports:
      # Orthanc Web UI and REST API
      - "8042:8042"
      # Orthanc main DICOM port
      - "4242:4242"
    volumes:
      # Mount the config for easier modification
      - ./orthanc.json:/etc/orthanc/orthanc.json
      # Persist Orthanc database
      - orthanc-db:/var/lib/orthanc/db
      # Persist logs
      - orthanc-logs:/var/log/orthanc
    env_file:
      - .env
    environment:
      - ORTHANC_CONFIG=/etc/orthanc/orthanc.json
    restart: unless-stopped
    networks:
      - mwl-network

  relay-listener:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: relay-listener
    entrypoint: python3
    command: /scripts/relay_listener.py
    volumes:
      # Mount the scripts directory for easier development
      - ./scripts:/scripts
      # Shared worklist database
      - worklist-db:/var/lib/worklist
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - WORKLIST_DB_PATH=/var/lib/worklist/worklist.db
    restart: unless-stopped
    networks:
      - mwl-network
    depends_on:
      - worklist-server

volumes:
  orthanc-db:
    driver: local
  orthanc-logs:
    driver: local
  worklist-db:
    driver: local
  worklist-logs:
    driver: local
  pacs-storage:
    driver: local
  pacs-logs:
    driver: local

networks:
  mwl-network:
    driver: bridge
